# Reference:
#   - https://github.com/actions/checkout
#   - https://github.com/pavelzw/pixi-diff-to-markdown
#   - https://github.com/peter-evans/create-pull-request
#   - https://github.com/prefix-dev/setup-pixi
#   - https://github.com/tibdex/github-app-token

name: ci-locks

on:
  workflow_dispatch:
  schedule:
    # every sunday @ 00h03
    - cron: "3 0 * * 0"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NAME: "geovista"
  SHELLOPTS: "errexit:pipefail"
  VERSION: "py312"

defaults:
  run:
    shell: bash -l {0}

jobs:
  pixi-update:
    name: "pixi update"
    runs-on: "ubuntu-22.04"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "environment configure"
        run: |
          echo "ENV_NAME=${{ env.NAME }}-${{ env.VERSION }}" >> ${GITHUB_ENV}

      - name: "setup pixi"
        uses: prefix-dev/setup-pixi@19eac09b398e3d0c747adc7921926a6d802df4da
        with:
          run-install: false

      - name: "refresh pixi manifest"
        run: |
          pixi update --json | pixi exec pixi-diff-to-markdown > diff.md
          if [ $(wc -c < diff.md) -lt 10 ]; then
            rm -f diff.md
          fi

      - name: "refresh lock and yml"
        if: ${{ hashFiles('diff.md') }}
        run: |
          pixi workspace export conda-explicit-spec --environment ${{ env.ENV_NAME }} --frozen --ignore-pypi-errors requirements/locks
          pixi workspace export conda-environment --environment ${{ env.ENV_NAME }} requirements/geovista.yml

      - name: "convert lock"
        if: ${{ hashFiles('diff.md') }}
        working-directory: requirements/locks
        run: |
          python lock2yaml.py ${{ env.VERSION }}

      - name: "generate token"
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a
        id: generate-token
        with:
          app_id: ${{ secrets.AUTH_APP_ID }}
          private_key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}

      - name: "create pull-request"
        id: cpr
        if: ${{ hashFiles('diff.md') }}
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e
        with:
          token: ${{ steps.generate-token.outputs.token }}
          add-paths: |
            ${{ github.workspace }}/pixi.lock
            ${{ github.workspace }}/requirements/geovista.yml
            ${{ github.workspace }}/requirements/locks/*_conda_spec.txt
            ${{ github.workspace }}/requirements/locks/*_conda_spec.yml
          commit-message: "updated manifest and lockfiles"
          branch: pixi-auto-update
          base: main
          delete-branch: true
          title: "chore: pixi manifest update"
          body-path: ${{ github.workspace }}/diff.md
          labels: |
            new: pull request
            bot
            pixi
            skip changelog

      - name: "show pull-request"
        if: ${{ hashFiles('diff.md') }}
        run: |
          echo "### :rocket: Pull-Request Summary" >> ${GITHUB_STEP_SUMMARY}
          echo "" >> ${GITHUB_STEP_SUMMARY}
          echo "The following locks pull-request has been auto-generated:" >> ${GITHUB_STEP_SUMMARY}
          echo "- **PR** #${{ steps.cpr.outputs.pull-request-number }}" >> ${GITHUB_STEP_SUMMARY}
          echo "- **URL** ${{ steps.cpr.outputs.pull-request-url }}" >> ${GITHUB_STEP_SUMMARY}
          echo "- **Operation** [${{ steps.cpr.outputs.pull-request-operation }}]" >> ${GITHUB_STEP_SUMMARY}
          echo "- **SHA** ${{ steps.cpr.outputs.pull-request-head-sha }}" >> ${GITHUB_STEP_SUMMARY}
